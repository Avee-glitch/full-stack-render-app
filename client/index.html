// CONFIGURATION
const API_BASE_URL = window.location.origin;

// ELEMENTS
const elements = {
    loginBtn: document.getElementById('loginBtn'),
    mobileLoginBtn: document.getElementById('mobileLoginBtn'),
    loginModal: document.getElementById('loginModal'),
    closeLogin: document.getElementById('closeLogin'),
    registerModal: document.getElementById('registerModal'),
    closeRegister: document.getElementById('closeRegister'),
    switchToRegister: document.getElementById('switchToRegister'),
    switchToLogin: document.getElementById('switchToLogin'),
    doLogin: document.getElementById('doLogin'),
    doRegister: document.getElementById('doRegister'),
    casesContainer: document.getElementById('casesContainer'),
    totalCases: document.getElementById('totalCases'),
    totalUsers: document.getElementById('totalUsers'),
    totalEvidence: document.getElementById('totalEvidence'),
    communityCount: document.getElementById('communityCount')
};

// MODAL FUNCTIONS
function showModal(modal) {
    if (modal) {
        modal.style.display = 'flex';
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
    }
}

function hideModal(modal) {
    if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('active');
        document.body.style.overflow = '';
    }
}

function hideAllModals() {
    hideModal(elements.loginModal);
    hideModal(elements.registerModal);
}

// AUTH FUNCTIONS
async function loginUser(email, password) {
    try {
        const response = await fetch(`${API_BASE_URL}/api/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
        });
        
        if (!response.ok) throw new Error('Login failed');
        const data = await response.json();
        alert('Login successful!');
        hideModal(elements.loginModal);
        return data;
    } catch (error) {
        alert('Login failed. Using demo mode.');
        return { user: { username: 'demo_user', role: 'viewer' } };
    }
}

async function registerUser(username, email, password) {
    try {
        const response = await fetch(`${API_BASE_URL}/api/auth/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, email, password })
        });
        
        if (!response.ok) throw new Error('Registration failed');
        const data = await response.json();
        alert('Registration successful!');
        hideModal(elements.registerModal);
        showModal(elements.loginModal);
        return data;
    } catch (error) {
        alert('Registration failed. Using demo mode.');
        return { user: { username, role: 'viewer' } };
    }
}

// DATA FUNCTIONS
async function loadCases() {
    try {
        const response = await fetch(`${API_BASE_URL}/api/cases`);
        if (!response.ok) throw new Error('Failed to load cases');
        const data = await response.json();
        
        if (elements.casesContainer) {
            if (data.data && data.data.length > 0) {
                elements.casesContainer.innerHTML = data.data.map(caseItem => `
                    <div class="case-card">
                        <div class="case-image">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="case-content">
                            <div class="case-header">
                                <span class="case-category">${caseItem.category}</span>
                                <span class="case-status ${caseItem.status}">${caseItem.status}</span>
                            </div>
                            <h3 class="case-title">${caseItem.title}</h3>
                            <p class="case-description">${caseItem.description}</p>
                            <div class="case-meta">
                                <div class="case-severity">
                                    <span class="severity-dot ${caseItem.severity}"></span>
                                    <span>${caseItem.severity}</span>
                                </div>
                                <div class="case-views">
                                    <i class="fas fa-eye"></i>
                                    <span>${caseItem.views}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                elements.casesContainer.innerHTML = '<div class="no-cases">No cases found. Be the first to submit one!</div>';
            }
        }
        return data;
    } catch (error) {
        console.error('Error loading cases:', error);
        if (elements.casesContainer) {
            elements.casesContainer.innerHTML = '<div class="error">Failed to load cases. Please try again.</div>';
        }
        return { data: [] };
    }
}

async function loadStats() {
    try {
        const response = await fetch(`${API_BASE_URL}/api/stats`);
        if (!response.ok) throw new Error('Failed to load stats');
        const data = await response.json();
        
        // Update stats on page
        if (elements.totalCases && data.data) {
            elements.totalCases.textContent = data.data.totalCases || '0';
            elements.totalUsers.textContent = data.data.totalUsers || '0';
            elements.totalEvidence.textContent = data.data.totalEvidence || '0';
            if (elements.communityCount) {
                elements.communityCount.textContent = `${data.data.totalUsers || '0'}+ contributors`;
            }
        }
        
        return data;
    } catch (error) {
        console.error('Error loading stats:', error);
        // Set default values
        if (elements.totalCases) elements.totalCases.textContent = '0';
        if (elements.totalUsers) elements.totalUsers.textContent = '0';
        if (elements.totalEvidence) elements.totalEvidence.textContent = '0';
        if (elements.communityCount) elements.communityCount.textContent = '0+ contributors';
        return { data: { totalCases: 0, totalUsers: 0, totalEvidence: 0 } };
    }
}

// EVENT LISTENERS
function setupEventListeners() {
    // LOGIN MODAL
    if (elements.loginBtn) {
        elements.loginBtn.addEventListener('click', () => showModal(elements.loginModal));
    }
    
    if (elements.mobileLoginBtn) {
        elements.mobileLoginBtn.addEventListener('click', () => showModal(elements.loginModal));
    }
    
    if (elements.closeLogin) {
        elements.closeLogin.addEventListener('click', () => hideModal(elements.loginModal));
    }
    
    // REGISTER MODAL
    if (elements.closeRegister) {
        elements.closeRegister.addEventListener('click', () => hideModal(elements.registerModal));
    }
    
    // MODAL SWITCHING
    if (elements.switchToRegister) {
        elements.switchToRegister.addEventListener('click', (e) => {
            e.preventDefault();
            hideModal(elements.loginModal);
            showModal(elements.registerModal);
        });
    }
    
    if (elements.switchToLogin) {
        elements.switchToLogin.addEventListener('click', (e) => {
            e.preventDefault();
            hideModal(elements.registerModal);
            showModal(elements.loginModal);
        });
    }
    
    // LOGIN FORM
    if (elements.doLogin) {
        elements.doLogin.addEventListener('click', async () => {
            const email = document.getElementById('loginEmail')?.value || 'demo@example.com';
            const password = document.getElementById('loginPassword')?.value || 'demo123';
            
            if (!email || !password) {
                alert('Please enter email and password');
                return;
            }
            
            await loginUser(email, password);
        });
    }
    
    // REGISTER FORM
    if (elements.doRegister) {
        elements.doRegister.addEventListener('click', async () => {
            const username = document.getElementById('regUsername')?.value || 'user_' + Date.now();
            const email = document.getElementById('regEmail')?.value || `user${Date.now()}@example.com`;
            const password = document.getElementById('regPassword')?.value || 'password123';
            const confirmPassword = document.getElementById('regConfirm')?.value || 'password123';
            
            if (!username || !email || !password) {
                alert('Please fill all fields');
                return;
            }
            
            if (password !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }
            
            await registerUser(username, email, password);
        });
    }
    
    // CLOSE MODALS ON OUTSIDE CLICK
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
            hideAllModals();
        }
    });
    
    // CLOSE MODALS ON ESCAPE KEY
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            hideAllModals();
        }
    });
}

// INITIALIZATION
async function init() {
    console.log('ðŸš€ AI Harm Watch Initializing...');
    
    // Setup event listeners
    setupEventListeners();
    
    // Load data
    await Promise.all([
        loadCases(),
        loadStats()
    ]);
    
    console.log('âœ… AI Harm Watch Ready!');
}

// START WHEN PAGE LOADS
document.addEventListener('DOMContentLoaded', init);

// MAKE FUNCTIONS AVAILABLE GLOBALLY FOR HTML ONCLICK
window.showModal = showModal;
window.hideModal = hideModal;
window.hideAllModals = hideAllModals;
